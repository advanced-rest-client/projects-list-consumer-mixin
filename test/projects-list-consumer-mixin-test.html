<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
  <title>projects-list-consumer-mixin test</title>
  <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <link rel="import" href="../../arc-data-generator/arc-data-generator.html">
  <link rel="import" href="../../arc-models/project-model.html">
  <link rel="import" href="../../arc-models/request-model.html">
  <script src="../../chance/dist/chance.min.js"></script>
  <link rel="import" href="test-element.html">
</head>
<body>
  <test-fixture id="NoModel">
    <template>
      <test-element no-auto-projects></test-element>
    </template>
  </test-fixture>

  <test-fixture id="NoAutoProjects">
    <template>
      <request-model></request-model>
      <project-model></project-model>
      <test-element no-auto-projects></test-element>
    </template>
  </test-fixture>

  <test-fixture id="AutoQuery">
    <template>
      <request-model></request-model>
      <project-model></project-model>
      <test-element></test-element>
    </template>
  </test-fixture>

  <script>
  /* global DataGenerator, chance */
  suite('projects-list-consumer-mixin', () => {
    suite('_computeHasProjects()', () => {
      let element;
      suiteSetup(() => {
        element = fixture('NoModel');
      });

      test('Returns false for no argument', () => {
        const result = element._computeHasProjects();
        assert.isFalse(result);
      });

      test('Returns false for no base property', () => {
        const result = element._computeHasProjects({});
        assert.isFalse(result);
      });

      test('Returns false for empty base', () => {
        const result = element._computeHasProjects({
          base: []
        });
        assert.isFalse(result);
      });

      test('Returns true for not empty base', () => {
        const result = element._computeHasProjects({
          base: [{_id: 'test'}]
        });
        assert.isTrue(result);
      });

      test('hasProjects is false by default', () => {
        assert.isFalse(element.hasProjects);
      });

      test('hasProjects is computed', () => {
        element.projects = [{id: 'test'}];
        assert.isTrue(element.hasProjects);
      });
    });

    suite('_projectDataImportHandler()', () => {
      let element;
      setup(() => {
        element = fixture('NoModel');
      });

      test('Calls refreshProjects() when called', () => {
        let called = false;
        element.refreshProjects = () => called = true;
        element._projectDataImportHandler({
          cancelable: false
        });
        assert.isTrue(called);
      });

      test('Won\'t call refreshProjects() when event is cancelable', () => {
        let called = false;
        element.refreshProjects = () => called = true;
        element._projectDataImportHandler({
          cancelable: true
        });
        assert.isFalse(called);
      });

      test('Calls refresh() when data-imported is handled', () => {
        let called = false;
        element.refreshProjects = () => called = true;
        document.body.dispatchEvent(new CustomEvent('data-imported', {
          bubbles: true
        }));
        assert.isTrue(called);
      });
    });

    suite('_projectDatabaseDestroyedHandler()', () => {
      let element;
      setup(() => {
        element = fixture('NoModel');
      });
      test('Calls refreshProjects() when called with "legacy-projects" datastore', () => {
        let called = false;
        element.refreshProjects = () => called = true;
        element._projectDatabaseDestroyedHandler({
          detail: {
            datastore: ['legacy-projects']
          }
        });
        assert.isTrue(called);
      });

      test('Calls refreshProjects() when called with "all" datastore', () => {
        let called = false;
        element.refreshProjects = () => called = true;
        element._projectDatabaseDestroyedHandler({
          detail: {
            datastore: ['legacy-projects']
          }
        });
        assert.isTrue(called);
      });

      test('Calls refreshProjects() when datastore is a string', () => {
        let called = false;
        element.refreshProjects = () => called = true;
        element._projectDatabaseDestroyedHandler({
          detail: {
            datastore: 'legacy-projects'
          }
        });
        assert.isTrue(called);
      });

      test('Calls refreshProjects() when datastore-destroyed is handled', () => {
        let called = false;
        element.refreshProjects = () => called = true;
        document.body.dispatchEvent(new CustomEvent('datastore-destroyed', {
          bubbles: true,
          detail: {
            datastore: ['legacy-projects']
          }
        }));
        assert.isTrue(called);
      });

      test('Do nothing when datastore not set', () => {
        let called = false;
        element.refreshProjects = () => called = true;
        element._projectDatabaseDestroyedHandler({
          detail: {}
        });
        assert.isFalse(called);
      });

      test('Do nothing when datastore is not an array', () => {
        let called = false;
        element.refreshProjects = () => called = true;
        element._projectDatabaseDestroyedHandler({
          detail: {
            datastore: true
          }
        });
        assert.isFalse(called);
      });

      test('Do nothing when datastore is not projects store', () => {
        let called = false;
        element.refreshProjects = () => called = true;
        element._projectDatabaseDestroyedHandler({
          detail: {
            datastore: 'saved'
          }
        });
        assert.isFalse(called);
      });
    });

    suite('_projectsSortFn()', () => {
      let element;
      setup(function() {
        element = fixture('NoModel');
      });

      test('Returns 0 when order equal', () => {
        const a = {
          order: 1
        };
        const b = {
          order: 1
        };
        const result = element._projectsSortFn(a, b);
        assert.equal(result, 0);
      });

      test('Returns 1 when A order is higher', () => {
        const a = {
          order: 1
        };
        const b = {
          order: 0
        };
        const result = element._projectsSortFn(a, b);
        assert.equal(result, 1);
      });

      test('Returns -1 when B order is higher', () => {
        const a = {
          order: 0
        };
        const b = {
          order: 1
        };
        const result = element._projectsSortFn(a, b);
        assert.equal(result, -1);
      });
    });

    suite('_computeProjectsAutocomplete()', () => {
      let element;
      setup(function() {
        element = fixture('NoModel');
      });

      test('Returns undefined when no argument', () => {
        const result = element._computeProjectsAutocomplete();
        assert.isUndefined(result);
      });

      test('Returns undefined when passed array is empty', () => {
        const result = element._computeProjectsAutocomplete([]);
        assert.isUndefined(result);
      });

      test('Returns undefined when argument is not an array', () => {
        const result = element._computeProjectsAutocomplete(123);
        assert.isUndefined(result);
      });

      test('Returns list of names', () => {
        const result = element._computeProjectsAutocomplete([{
          name: 't1'
        }, {
          name: 't2'
        }]);
        assert.deepEqual(result, ['t1', 't2']);
      });
    });

    suite('_dispatchProjectQueryEvent()', () => {
      let element;
      setup(function() {
        element = fixture('NoModel');
      });

      test('Dispatches "project-model-query" custom event', () => {
        let called = false;
        element.addEventListener('project-model-query', function f(e) {
          element.removeEventListener('project-model-query', f);
          e.preventDefault();
          called = true;
        });
        element._dispatchProjectQueryEvent();
        assert.isTrue(called);
      });

      test('Returns custom event', () => {
        const result = element._dispatchProjectQueryEvent();
        assert.typeOf(result, 'customevent');
      });

      test('Custom event has detail object', () => {
        const result = element._dispatchProjectQueryEvent();
        assert.typeOf(result.detail, 'object');
      });

      test('Detail is empty', () => {
        const result = element._dispatchProjectQueryEvent();
        assert.lengthOf(Object.keys(result.detail), 0);
      });
    });

    suite('_processSelectedProjectsInfo()', () => {
      let element;
      setup(function() {
        element = fixture('NoModel');
      });

      test('Returns object when no argument', () => {
        const result = element._processSelectedProjectsInfo();
        assert.typeOf(result, 'object');
      });

      test('Returns object when argument is empty', () => {
        const result = element._processSelectedProjectsInfo([]);
        assert.typeOf(result, 'object');
      });

      test('Object has empty "add" list', () => {
        const result = element._processSelectedProjectsInfo([]);
        assert.typeOf(result.add, 'array');
        assert.lengthOf(result.add, 0);
      });

      test('Object has empty "existing" list', () => {
        const result = element._processSelectedProjectsInfo([]);
        assert.typeOf(result.existing, 'array');
        assert.lengthOf(result.existing, 0);
      });

      test('Add projects to "add" proeprty when projects do not exist', () => {
        const result = element._processSelectedProjectsInfo(['a', 'b']);
        assert.deepEqual(result.add, ['a', 'b']);
        assert.lengthOf(result.existing, 0);
      });

      test('Skips empty names', () => {
        const result = element._processSelectedProjectsInfo(['a', '', 'b']);
        assert.deepEqual(result.add, ['a', 'b']);
        assert.lengthOf(result.existing, 0);
      });

      test('Add projects to "existing" proeprty when projects exist', () => {
        element.projects = [{
          name: 'a',
          _id: 'aId'
        }, {
          name: 'b',
          _id: 'bId'
        }];
        const result = element._processSelectedProjectsInfo(['a', 'b']);
        assert.deepEqual(result.existing, ['aId', 'bId']);
        assert.lengthOf(result.add, 0);
      });
    });

    suite('refreshProjects()', () => {
      let element;
      setup(function() {
        element = fixture('NoModel');
      });

      test('Eventually calls _updateProjectsList()', (done) => {
        let called = false;
        element._updateProjectsList = () => called = true;
        element.refreshProjects();
        Polymer.RenderStatus.afterNextRender(this, () => {
          assert.isTrue(called);
          done();
        });
      });

      test('Sets __refreshingDebouncer flag', (done) => {
        element._updateProjectsList = () => done();
        element.refreshProjects();
        assert.isTrue(element.__refreshingDebouncer);
      });

      test('Clears __refreshingDebouncer flag after callback', (done) => {
        element._updateProjectsList = () => {
          assert.isFalse(element.__refreshingDebouncer);
          done();
        };
        element.refreshProjects();
      });

      test('Do nothing when __refreshingDebouncer flag is set', (done) => {
        let called = false;
        element._updateProjectsList = () => called = true;
        element.__refreshingDebouncer = true;
        element.refreshProjects();
        Polymer.RenderStatus.afterNextRender(this, () => {
          assert.isFalse(called);
          done();
        });
      });
    });

    suite('_handleProjectsError()', () => {
      let element;
      setup(function() {
        element = fixture('NoModel');
      });

      test('Dispatches "send-analytics" custom event', () => {
        let called = false;
        element.addEventListener('send-analytics', function f() {
          element.removeEventListener('send-analytics', f);
          called = true;
        });
        try {
          element._handleProjectsError(new Error('test-message'));
        } catch (_) {}
        assert.isTrue(called);
      });

      test('"send-analytics" has required properties', () => {
        let eventData;
        element.addEventListener('send-analytics', function f(e) {
          element.removeEventListener('send-analytics', f);
          eventData = e.detail;
        });
        try {
          element._handleProjectsError(new Error('test-message'));
        } catch (_) {}
        assert.typeOf(eventData, 'object', 'e.detail is an object');
        assert.equal(eventData.type, 'exception', 'type is set');
        assert.equal(eventData.description,
          '[projects-list-consumer]: test-message', 'message is set');
        assert.isFalse(eventData.fatal, 'fatal is set');
      });

      test('Throws the same error', () => {
        assert.throws(() => {
          element._handleProjectsError(new Error('test-message'));
        });
      });
    });

    suite('_projectChangedHandler()', () => {
      let element;
      let projects;
      let changedName;
      setup(function() {
        element = fixture('NoAutoProjects')[2];
        changedName = chance.word();
      });

      suiteSetup(() => {
        return DataGenerator.insertProjectsData({
          projectsSize: 20,
          autoRequestId: true
        })
        .then((data) => {
          projects = data;
        });
      });

      suiteTeardown(() => {
        return DataGenerator.destroySavedRequestData();
      });

      test('Does nothing when event is cancelable', () => {
        const updated = Object.assign({}, projects[0]);
        updated.name = changedName;
        element._projectChangedHandler({
          cancelable: true,
          detail: {
            project: updated
          }
        });
        assert.isUndefined(element.projects);
      });

      test('Does nothing when no project on the event', () => {
        element._projectChangedHandler({
          cancelable: false,
          detail: {}
        });
        assert.isUndefined(element.projects);
      });

      test('Does nothing when project has no ID', () => {
        element._projectChangedHandler({
          cancelable: false,
          detail: {
            project: {}
          }
        });
        assert.isUndefined(element.projects);
      });

      test('Creates list of projects when undefined', () => {
        const updated = Object.assign({}, projects[0]);
        updated.name = changedName;
        element._projectChangedHandler({
          cancelable: false,
          detail: {
            project: updated
          }
        });
        assert.typeOf(element.projects, 'array');
        assert.lengthOf(element.projects, 1);
      });

      test('Created list has updated item', () => {
        const updated = Object.assign({}, projects[0]);
        updated.name = changedName;
        element._projectChangedHandler({
          cancelable: false,
          detail: {
            project: updated
          }
        });
        assert.deepEqual(element.projects[0], updated);
      });

      test('Updates item on the list', () => {
        const updated = Object.assign({}, projects[0]);
        updated.name = changedName;
        element.projects = Array.from(projects);
        element._projectChangedHandler({
          cancelable: false,
          detail: {
            project: updated
          }
        });
        assert.equal(element.projects[0].name, changedName);
      });

      test('Adds new item to the list', () => {
        const updated = Object.assign({}, projects[0]);
        updated.name = changedName;
        updated._id = 'test-id';
        element.projects = Array.from(projects);
        element._projectChangedHandler({
          cancelable: false,
          detail: {
            project: updated
          }
        });
        assert.lengthOf(element.projects, 21);
        assert.equal(element.projects[20].name, changedName);
      });

      test('Handles project-object-changed event', () => {
        const updated = Object.assign({}, projects[0]);
        updated.name = changedName;
        document.body.dispatchEvent(new CustomEvent('project-object-changed', {
          bubbles: true,
          detail: {
            project: updated
          }
        }));
        assert.typeOf(element.projects, 'array');
        assert.lengthOf(element.projects, 1);
        assert.deepEqual(element.projects[0], updated);
      });
    });

    suite('_projectDeletedHandler()', () => {
      let element;
      let projects;
      setup(function() {
        element = fixture('NoAutoProjects')[2];
      });

      suiteSetup(() => {
        return DataGenerator.insertProjectsData({
          projectsSize: 20,
          autoRequestId: true
        })
        .then((data) => {
          projects = data;
        });
      });

      suiteTeardown(() => {
        return DataGenerator.destroySavedRequestData();
      });

      test('Does nothing when event is cancelable', () => {
        element.projects = Array.from(projects);
        element._projectDeletedHandler({
          cancelable: true,
          detail: {
            id: projects[0]._id
          }
        });
        assert.lengthOf(element.projects, 20);
      });

      test('Does nothing when no project ID on the event', () => {
        element.projects = Array.from(projects);
        element._projectDeletedHandler({
          cancelable: false,
          detail: {}
        });
        assert.lengthOf(element.projects, 20);
      });

      test('Does nothing when no projects ', () => {
        element._projectDeletedHandler({
          cancelable: false,
          detail: {
            id: projects[0]._id
          }
        });
        // It's about not throwing an error
        assert.isUndefined(element.projects);
      });

      test('Removes project from the list ', () => {
        element.projects = Array.from(projects);
        element._projectDeletedHandler({
          cancelable: false,
          detail: {
            id: projects[0]._id
          }
        });
        assert.lengthOf(element.projects, 19);
      });

      test('Ignores other requests ', () => {
        element.projects = Array.from(projects);
        assert.lengthOf(element.projects, 20, 'Initially has 20 requests');
        element._projectDeletedHandler({
          cancelable: false,
          detail: {
            id: 'test'
          }
        });
        assert.lengthOf(element.projects, 20);
      });
    });

    suite('_updateProjectsList()', () => {
      suiteSetup(() => {
        return DataGenerator.insertProjectsData({
          projectsSize: 20,
          autoRequestId: true
        });
      });

      suiteTeardown(() => {
        return DataGenerator.destroySavedRequestData();
      });

      test('Eventually updates projects list', (done) => {
        const element = fixture('NoAutoProjects')[2];
        element.addEventListener('has-projects-changed', function f(e) {
          if (!e.detail.value) {
            return;
          }
          element.removeEventListener('has-projects-changed', f);
          assert.typeOf(element.projects, 'array');
          assert.lengthOf(element.projects, 20);
          done();
        });
        element._updateProjectsList();
      });

      test('Throws an error when event is not handled', () => {
        const element = fixture('NoModel');
        assert.throws(() => {
          element._updateProjectsList();
        });
      });

      test('Calls _handleProjectsError() when database error', (done) => {
        const element = fixture('NoModel');
        element.addEventListener('project-model-query', function f(e) {
          element.removeEventListener('project-model-query', f);
          e.preventDefault();
          e.detail.result = Promise.reject(new Error('test'));
        });
        let called = false;
        element._handleProjectsError = () => called = true;
        const p = element._updateProjectsList();
        p.then(() => {
          if (called) {
            done();
          } else {
            done(new Error('Function not called'));
          }
        });
      });

      test('Requests projects list when attached to the DOM', (done) => {
        const element = fixture('AutoQuery')[2];
        element.addEventListener('has-projects-changed', function f(e) {
          if (!e.detail.value) {
            return;
          }
          element.removeEventListener('has-projects-changed', f);
          assert.typeOf(element.projects, 'array');
          assert.lengthOf(element.projects, 20);
          done();
        });
      });
    });
  });
  </script>
</body>
</html>
